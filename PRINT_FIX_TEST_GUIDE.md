# 打印修复测试指南

## 📋 修复内容概要

本次修复解决了两个关键问题:

### 1. ✅ BLE 与 Classic 地址转换
- **问题**: 打印机有两个地址,应用使用了错误的 BLE 地址
- **修复**: 自动检测并转换为 Classic 配对地址

### 2. ✅ 打印线程异步等待
- **问题**: 打印线程启动后立即返回,未等待实际打印完成
- **修复**: 使用 `thread.join()` 等待打印完成

### 3. ✅ 日期选择功能
- **问题**: 用户选择日期后数据库仍保存当前时间
- **修复**: 保存和打印使用用户选择的日期

---

## 🔧 测试前准备

### 1. 安装新版本
```powershell
cd K:\NFC\NFCApp
.\adb.exe install -r app\build\outputs\apk\debug\app-debug.apk
```

### 2. 确认打印机配对状态

**重要**: 必须配对 **Classic 版本** 的设备!

#### 检查方法:
```powershell
# 查看已配对设备
.\adb.exe shell dumpsys bluetooth_manager | findstr "AQ-V"
```

#### 应该看到:
```
✅ Name: AQ-V258007640  (无 BLE 后缀)
   Address: CD:AC:B0:07:00:72
   Bond state: BOND_BONDED
```

#### 如果看到:
```
❌ Name: AQ-V258007640(BLE)  (有 BLE 后缀)
   → 这是扫描地址,无法用于打印!
```

### 3. 重新配对 (如果需要)

**步骤**:
1. 手机 **设置 → 蓝牙**
2. 找到 `AQ-V258007640(BLE)` → **取消配对** (如果已配对)
3. 在"可用设备"中找到 `AQ-V258007640` (无 BLE 后缀)
4. 点击配对,输入 PIN 码: `0000` 或 `1234`
5. 配对成功后返回应用

---

## 🧪 测试步骤

### 测试 1: 地址转换验证

**目的**: 验证应用能正确转换 BLE 地址为 Classic 地址

#### 1.1 启动日志监控
```powershell
.\adb.exe logcat -c  # 清空日志
.\adb.exe logcat -s PuQuPrinterManager:D MainActivity:D
```

#### 1.2 执行打印
1. 打开 NFCApp
2. 读取 NFC 卡
3. 填写金额: `100`
4. 点击"确认"

#### 1.3 检查日志

**期望看到**:
```
[PuQuPrinterManager] ========== 打印到指定打印机 ==========
[PuQuPrinterManager] 原始地址: CD:AC:B0:F0:31:FC (或类似BLE地址)
[PuQuPrinterManager] 检测到 BLE 设备,尝试获取 Classic 地址...
[PuQuPrinterManager] ✓ 已转换: BLE -> Classic 地址: CD:AC:B0:07:00:72
[PuQuPrinterManager] 实际连接地址: CD:AC:B0:07:00:72
[PuQuPrinterManager] ✓ 打印机已连接
```

**如果看到**:
```
❌ [PuQuPrinterManager] ⚠️ 未找到 Classic 地址,使用原始地址
```
→ 说明 Classic 设备未配对,参考"测试前准备"重新配对

---

### 测试 2: 打印功能验证

**目的**: 验证打印线程正确执行并等待完成

#### 2.1 执行打印
1. 读取 NFC 卡
2. 填写金额: `200`
3. 点击"确认"

#### 2.2 检查日志

**期望看到完整流程**:
```
[PuQuPrinterManager] ========== 开始生成打印内容 ==========
[PuQuPrinterManager] 步骤1: startJob(400, -1)
[PuQuPrinterManager] 步骤2: 打印标题
[PuQuPrinterManager] 步骤3: 打印内容
[PuQuPrinterManager] 使用加油日期: 2025-11-13
[PuQuPrinterManager] 步骤5: 后台线程执行 printJob()
[PuQuPrinterManager] 后台线程: 开始 printJob()...
[PuQuPrinterManager] 后台线程: printJob() 完成  ← 关键!
[PuQuPrinterManager] ========== 打印命令已完成 ==========
[PuQuPrinterManager] ✓✓✓ 打印成功
[MainActivity] ✓ 第1份小票打印成功
[MainActivity] ✓ 第2份小票打印成功
[MainActivity] ✓ 2份小票打印完成
```

#### 2.3 验证物理输出

**检查打印机**:
- ✅ 应输出 **2 张小票**
- ✅ 内容包含: 卡号、车号、金额、日期等
- ✅ 格式正确,字体清晰

---

### 测试 3: 日期选择功能

**目的**: 验证用户选择的日期正确保存和打印

#### 3.1 选择日期
1. 打开应用
2. 点击"加油时间"栏
3. 选择昨天的日期 (例如 2025-11-12)
4. 确认选择

#### 3.2 执行打印
1. 读取 NFC 卡
2. 填写金额: `300`
3. 点击"确认"

#### 3.3 检查日志

**期望看到**:
```
[MainActivity] 用户选择加油日期: 2025-11-12
[PuQuPrinterManager] 使用加油日期: 2025-11-12 (时间戳: 1731340800000)
```

#### 3.4 验证数据库

```powershell
.\adb.exe shell "run-as com.nfc.app sqlite3 /data/data/com.nfc.app/databases/nfc_database 'SELECT readTime, datetime(readTime/1000, \"unixepoch\", \"localtime\") FROM nfc_records ORDER BY id DESC LIMIT 1;'"
```

**期望输出**:
```
1731340800000|2025-11-12 00:00:00
```

#### 3.5 验证小票内容

**检查打印的小票**:
- 时间行应显示: `时间: 2025-11-12 00:00:00`
- 而非当前时间

---

### 测试 4: 多次打印稳定性

**目的**: 验证连续打印的稳定性

#### 4.1 连续打印 5 次
1. 读取 NFC 卡
2. 打印金额: 100
3. 等待打印完成
4. 重复步骤 1-3,共 5 次

#### 4.2 检查成功率

**期望结果**:
- ✅ 5 次打印全部成功
- ✅ 每次输出 2 张小票,共 10 张
- ✅ 无连接错误
- ✅ 无打印超时

---

### 测试 5: 更换打印机

**目的**: 验证打印机切换功能

#### 5.1 配对多台打印机
- 至少配对 2 台 AQ 打印机

#### 5.2 首次打印
1. 读取 NFC 卡
2. 填写金额: 100
3. 选择打印机 A
4. 确认打印

#### 5.3 切换打印机
1. 读取 NFC 卡
2. 填写金额: 200
3. 选择打印机 B (不同于 A)
4. 确认打印

#### 5.4 检查日志

**期望看到**:
```
[PuQuPrinterManager] 检测到更换打印机,断开旧连接: CD:AC:B0:07:00:72
[PuQuPrinterManager] 连接打印机: CD:AC:B0:07:00:73
[PuQuPrinterManager] ✓ 打印机已连接
```

---

## 📊 测试结果记录

### 测试环境
- 日期: 2025-11-13
- 设备型号: _____________
- Android 版本: _____________
- 打印机型号: AQ-V258007640
- Classic 地址: _____________

### 测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 1. 地址转换 | ⬜ 通过 / ⬜ 失败 | |
| 2. 打印功能 | ⬜ 通过 / ⬜ 失败 | |
| 3. 日期选择 | ⬜ 通过 / ⬜ 失败 | |
| 4. 连续打印 | ⬜ 通过 / ⬜ 失败 | 成功率: __/5 |
| 5. 更换打印机 | ⬜ 通过 / ⬜ 失败 | |

---

## 🐛 常见问题

### Q1: 日志显示"未找到 Classic 地址"

**解决方法**:
1. 进入手机蓝牙设置
2. 取消配对 `AQ-V258007640(BLE)`
3. 配对 `AQ-V258007640` (无 BLE 后缀)
4. 重启应用

### Q2: 打印机连接超时

**可能原因**:
- 打印机未开机
- 蓝牙未开启
- 打印机距离太远
- 配对设备不正确

**解决方法**:
```powershell
# 查看蓝牙状态
.\adb.exe shell dumpsys bluetooth_manager | findstr "enabled"

# 应该看到: enabled: true
```

### Q3: 打印了 BLE 后缀的设备名称仍然失败

**原因**: 系统中没有配对 Classic 版本

**解决**:
- Classic 设备和 BLE 设备名称不同
- 必须在蓝牙设置的"可用设备"中找到无后缀的设备配对

### Q4: 日期选择器不显示

**检查**:
```bash
.\adb.exe logcat -s MainActivity:E
```

如果看到异常,可能是权限问题或布局加载问题。

---

## ✅ 测试完成检查清单

- [ ] 地址转换日志正确
- [ ] 打印机成功连接
- [ ] 两张小票正常输出
- [ ] 日期选择功能正常
- [ ] 数据库保存正确日期
- [ ] 小票显示正确日期
- [ ] 连续打印稳定
- [ ] 切换打印机正常
- [ ] 无内存泄漏或崩溃
- [ ] 用户体验流畅

---

## 📝 测试报告模板

```
测试日期: 2025-11-13
测试人员: ___________
设备信息: ___________
打印机型号: AQ-V258007640

测试结果: ✅ 通过 / ❌ 失败

详细说明:
1. 地址转换: _____________________
2. 打印功能: _____________________
3. 日期选择: _____________________
4. 稳定性: _______________________

问题记录:
- 问题1: ________________________
- 问题2: ________________________

建议:
- _______________________________
```

---

**提示**: 如果遇到问题,请保存完整日志:
```powershell
.\adb.exe logcat -d > test-log.txt
```
然后将 `test-log.txt` 发送给开发人员分析。
