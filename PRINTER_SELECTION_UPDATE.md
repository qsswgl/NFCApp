# 打印机选择功能更新说明

**更新时间**: 2025-01-16  
**版本**: v2.4 - 多打印机支持  
**目标打印机**: AQ-V258007640 及其他 AQ-V 系列

---

## 🎯 本次更新内容

### 新增功能
1. **智能打印机选择**
   - ✅ 自动搜索所有已配对的 AQ-V 打印机
   - ✅ 0个打印机: 显示配对指引并打开蓝牙设置
   - ✅ 1个打印机: 自动选择并打印
   - ✅ 多个打印机: 显示选择对话框让用户选择

2. **新增方法**
   - `selectPrinterAndPrint()` - 智能选择打印机
   - `printReceipts()` - 打印2份小票到指定地址
   - `getPairedPrinters()` - 获取已配对的 AQ-V 打印机列表
   - `printToAddress()` - 连接并打印到指定打印机地址

3. **改进点**
   - 支持多打印机环境
   - 用户可手动选择具体打印机
   - 显示详细的打印机信息(名称 + 地址)
   - 完美适配 AQ-V258007640 等新型号

---

## 📱 安装步骤

### 前提条件
- 物理机上已安装 ADB 工具
- 手机通过 USB 连接到物理机
- 手机已开启 USB 调试模式
- 打印机 AQ-V258007640 已在手机上完成蓝牙配对

### 安装命令 (在物理机上执行)

```powershell
# 1. 进入 ADB 目录
cd K:\NFC\NFCApp

# 2. 检查设备连接
.\adb.exe devices
# 应该显示你的设备序列号

# 3. 卸载旧版本 (可选)
.\adb.exe uninstall com.nfc.app

# 4. 安装新版本
.\adb.exe install "app\build\outputs\apk\debug\app-debug.apk"

# 5. 启动应用
.\adb.exe shell am start -n com.nfc.app/.MainActivity
```

### 安装成功标志
```
Success
```

---

## 🧪 测试步骤

### 测试场景 1: 单个打印机环境
**前提**: 手机只配对了1个 AQ-V 打印机

1. 打开应用,读取 NFC 卡
2. 填写金额
3. 点击 "确认" 按钮
4. **预期结果**: 
   - ✅ 自动连接打印机 AQ-V258007640
   - ✅ 打印第1份小票
   - ✅ 等待2秒
   - ✅ 打印第2份小票
   - ✅ 显示 "2份小票打印完成"

### 测试场景 2: 多个打印机环境
**前提**: 手机配对了多个 AQ-V 打印机

1. 打开应用,读取 NFC 卡
2. 填写金额
3. 点击 "确认" 按钮
4. **预期结果**:
   - ✅ 弹出打印机选择对话框
   - ✅ 显示所有可用打印机,例如:
     ```
     AQ-V258007640
     CD:AC:B0:07:00:72
     
     AQ-V258000114
     CD:AC:B0:07:01:83
     ```
5. 选择 AQ-V258007640
6. **预期结果**:
   - ✅ 连接选中的打印机
   - ✅ 打印2份小票
   - ✅ 显示成功提示

### 测试场景 3: 未配对打印机
**前提**: 手机没有配对任何 AQ-V 打印机

1. 打开应用,读取 NFC 卡
2. 填写金额
3. 点击 "确认" 按钮
4. **预期结果**:
   - ✅ 弹出提示: "未找到已配对的 AQ-V 打印机"
   - ✅ 提示内容包括配对步骤
   - ✅ "去配对" 按钮打开蓝牙设置页面

---

## 📊 日志查看

### 实时日志监控
```powershell
# 在物理机上执行
.\adb.exe logcat -v time | Select-String "PuQuPrinterManager|NFCApp|MainActivity"
```

### 关键日志标识

#### 1. 搜索打印机
```
PuQuPrinterManager: 找到 2 个已配对的打印机:
PuQuPrinterManager:   [1] AQ-V258007640 - CD:AC:B0:07:00:72
PuQuPrinterManager:   [2] AQ-V258000114 - CD:AC:B0:07:01:83
```

#### 2. 用户选择打印机
```
MainActivity: 用户选择打印机: AQ-V258007640 (CD:AC:B0:07:00:72)
```

#### 3. 连接打印机
```
PuQuPrinterManager: ========== 打印到指定打印机 ==========
PuQuPrinterManager: 打印机地址: CD:AC:B0:07:00:72
PuQuPrinterManager: 连接打印机: CD:AC:B0:07:00:72
PuQuPrinterManager: 等待连接...
PuQuPrinterManager: ✓ 打印机已连接
```

#### 4. 打印过程
```
MainActivity: 开始打印第1份小票...
PuQuPrinterManager: 开始打印...
PuQuPrinterManager: ✓✓✓ 打印成功
MainActivity: ✓ 第1份小票打印成功
MainActivity: 开始打印第2份小票...
PuQuPrinterManager: ✓✓✓ 打印成功
MainActivity: ✓ 第2份小票打印成功
```

---

## 🔧 故障排查

### 问题 1: 找不到打印机
**现象**: 提示 "未找到已配对的 AQ-V 打印机"

**解决方案**:
1. 确认打印机已开机
2. 检查手机蓝牙是否开启
3. 在手机蓝牙设置中查看是否已配对 AQ-V258007640
4. 如果未配对,点击 "去配对" 按钮进行配对
5. 配对成功后重新点击 "确认" 按钮

### 问题 2: 连接超时
**现象**: 日志显示 "连接超时 (20秒)"

**解决方案**:
1. 检查打印机是否在蓝牙范围内 (建议2米内)
2. 重启打印机
3. 检查打印机是否被其他设备占用
4. 在手机蓝牙设置中 "取消配对" 后重新配对

### 问题 3: 打印失败
**现象**: 第1份或第2份小票打印失败

**解决方案**:
1. 检查打印机纸张是否充足
2. 检查打印机电量是否充足
3. 重启打印机后重试
4. 查看详细日志定位具体错误

### 问题 4: 选择对话框不显示
**现象**: 有多个打印机但没有弹出选择框

**解决方案**:
1. 检查 logcat 日志,确认是否检测到多个打印机
2. 确认打印机名称是否以 "AQ-V" 开头
3. 如果打印机名称不符,在代码中调整过滤条件

---

## 📝 代码修改说明

### MainActivity.kt

#### 修改的方法
```kotlin
// handleConfirm() - 确认按钮逻辑
// 原来: 直接调用 autoPrintReceipt() × 2
// 现在: 调用 selectPrinterAndPrint()
```

#### 新增的方法
```kotlin
// 1. selectPrinterAndPrint() - 智能选择打印机
//    - 获取已配对的 AQ-V 打印机列表
//    - 根据数量决定显示对话框或自动打印

// 2. printReceipts() - 打印2份到指定地址
//    - 接收用户选择的打印机地址
//    - 依次打印2份,中间延迟2秒
```

### PuQuPrinterManager.kt

#### 新增的方法
```kotlin
// 1. getPairedPrinters() - 获取已配对的 AQ-V 打印机
//    - 过滤所有以 "AQ-V" 开头的已配对设备
//    - 返回 List<BluetoothDevice>

// 2. printToAddress() - 打印到指定地址
//    - 连接指定的打印机地址
//    - 等待连接成功 (最多20秒)
//    - 调用 printReceiptContent() 打印内容
```

---

## 🎯 测试清单

- [ ] 安装新版本 APK 成功
- [ ] 应用正常启动
- [ ] NFC 读卡功能正常
- [ ] 单个打印机环境测试通过
- [ ] 多个打印机环境测试通过 (如有多个打印机)
- [ ] 打印机选择对话框显示正确
- [ ] 选择 AQ-V258007640 后成功打印2份
- [ ] 2份小票内容一致
- [ ] 小票格式正确 (标题、内容、签字栏)
- [ ] 未配对场景提示正确

---

## 📌 重要提示

1. **首次使用前**:
   - 确保 AQ-V258007640 已在手机蓝牙设置中完成配对
   - 配对过程: 设置 → 蓝牙 → 搜索设备 → 选择 AQ-V258007640 → 配对

2. **配对名称**:
   - 打印机名称必须以 "AQ-V" 开头才会被识别
   - 示例: AQ-V258007640, AQ-V258000114
   - 如果打印机名称不同,请在代码中调整过滤条件

3. **经典蓝牙 vs BLE**:
   - 配对和连接使用经典蓝牙 (Classic Bluetooth)
   - 地址格式: CD:AC:B0:07:00:72
   - BLE 地址不同于配对地址,不要混淆

4. **打印质量**:
   - 每次打印2份,间隔2秒
   - 确保打印机状态稳定再打印第2份

---

## 📞 技术支持

如遇到问题,请提供以下信息:
1. 手机型号和 Android 版本
2. 打印机型号 (例如: AQ-V258007640)
3. logcat 完整日志
4. 问题发生的具体场景

---

**更新完成! 祝测试顺利! 🎉**
