# NFC停车缴费系统 - 蓝牙打印功能使用说明

## 📱 新增功能

### ✅ 已实现
1. **车号默认值**：车号输入框默认显示"1"
2. **金额输入框**：新增金额输入框，支持小数输入
3. **蓝牙打印**：点击打印按钮自动连接POS58打印机并打印小票

## 🖨️ 打印功能说明

### 小票内容
```
================================
        停车缴费小票
================================
--------------------------------
卡号: [输入的卡号]

车号: [输入的车号]

金额: [输入的金额] 元
--------------------------------
      2025-11-05 14:30:25
      
         谢谢使用!


[自动切纸]
```

### 打印机要求
- **型号**：POS58或兼容ESC/POS指令的58mm热敏打印机
- **连接方式**：蓝牙（需要提前在手机系统设置中配对打印机）
- **编码**：支持GBK中文编码

## 📋 使用步骤

### 1. 配对蓝牙打印机
在手机上：
1. 打开蓝牙设置
2. 搜索并配对打印机（通常名称包含"POS"或"Print"）
3. 输入配对码（通常是0000或1234）

### 2. 使用应用打印
1. 在应用中输入：
   - **卡号**：必填
   - **车号**：默认为1，可修改
   - **金额**：必填，支持小数（如：50.5）
2. 点击 **🖨️ 打印** 按钮
3. 等待提示：
   - "正在连接打印机..."
   - "✓ 打印机已连接"
   - "✓ 打印成功！"

### 3. 首次使用权限
首次使用时，应用会请求蓝牙权限：
- **Android 12+**：需要授予"附近设备"权限
- **Android 11-**：需要授予"蓝牙"权限

## 🔧 技术实现

### 核心类
- **BluetoothPrinter.kt**：蓝牙打印核心类
  - `connectToPrinter()`：自动搜索并连接已配对的打印机
  - `printReceipt()`：格式化打印小票
  - ESC/POS指令支持

### ESC/POS指令
```kotlin
INIT           // 初始化打印机
ALIGN_CENTER   // 居中对齐
FONT_LARGE     // 大字体
BOLD_ON        // 加粗
LINE_FEED      // 换行
CUT_PAPER      // 切纸
```

### 字符编码
使用GBK编码确保中文正确显示：
```kotlin
"停车缴费小票".toByteArray(Charset.forName("GBK"))
```

## ⚠️ 注意事项

1. **蓝牙配对**：必须先在系统设置中配对打印机
2. **打印机开机**：确保打印机已开机且蓝牙已开启
3. **纸张准备**：确保打印机有足够的热敏纸
4. **权限授予**：首次使用时请允许蓝牙权限
5. **距离限制**：蓝牙有效距离约10米

## 🐛 故障排查

### "打印机连接失败"
- 检查打印机是否已配对
- 检查打印机是否开机
- 尝试重启手机蓝牙
- 确认打印机名称包含"POS"或"Print"

### "蓝牙权限被拒绝"
- 进入系统设置 → 应用 → NFC读写系统 → 权限
- 开启"附近设备"或"蓝牙"权限

### "打印失败"
- 检查打印机纸张是否充足
- 重新连接打印机
- 查看Logcat日志：`adb logcat -s NFCApp`

### "打印内容乱码"
- 确认打印机支持GBK编码
- 某些打印机可能需要更换为GB2312编码

## 📊 打印日志

可通过ADB查看详细日志：
```powershell
K:\tool\adb\adb.exe logcat -s BluetoothPrinter
```

日志示例：
```
D/BluetoothPrinter: Connecting to: POS-5801
D/BluetoothPrinter: Connected to POS-5801
D/BluetoothPrinter: Receipt printed successfully
```

## 🔄 更新部署

编译并安装最新版本：
```powershell
# 方式1：使用批处理脚本
K:\NFC\NFCApp\install-to-phone.bat

# 方式2：手动命令
cd K:\NFC\NFCApp
.\gradlew.bat assembleDebug
K:\tool\adb\adb.exe install -r app\build\outputs\apk\debug\app-debug.apk
```

## 📝 版本信息

- **版本**：v1.1.0
- **更新日期**：2025-11-05
- **新增功能**：
  - 车号默认值为1
  - 金额输入框
  - POS58蓝牙打印支持
  - 自动连接已配对打印机
  - 格式化小票打印

## 💡 提示

- 打印机配对成功后会自动记住，下次无需重新配对
- 支持多台打印机，优先连接名称包含"POS"的设备
- 打印速度取决于蓝牙传输速率和打印机性能
- 建议使用质量好的热敏纸以获得最佳打印效果
